@page "/bomberman-online"
@inject IJSRuntime JS
@inject BombermanHubClient HubClient

<h3 class="text-center">Bomberman Online 🧨</h3>

<div class="game-container" style="max-width:400px; margin:auto;">
    <canvas id="bomberCanvas" width="400" height="400" style="border:1px solid #ccc; width:100%; height:auto;"></canvas>

    <!-- Controls -->
    <div class="controls d-flex justify-content-between mt-3">
        <div class="d-flex flex-column align-items-center gap-2">
            <button class="btn btn-secondary" @onclick='() => Move("UP")'>⬆️</button>
            <div class="d-flex gap-2">
                <button class="btn btn-secondary" @onclick='() => Move("LEFT")'>⬅️</button>
                <div style="width:60px;"></div>
                <button class="btn btn-secondary" @onclick='() => Move("RIGHT")'>➡️</button>
            </div>
            <button class="btn btn-secondary" @onclick='() => Move("DOWN")'>⬇️</button>
        </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-danger" style="font-size:24px;" @onclick="PlaceBomb">💣</button>
        </div>
    </div>

    <div class="mt-3 text-end">
        <button class="btn btn-outline-secondary" @onclick="ResetGame">Reset</button>
    </div>
</div>

@code {
    private string serverUrl = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Auto-detect URL for PC vs Android emulator
        if (OperatingSystem.IsAndroid())
        {
            serverUrl = "http://10.0.2.2:5170"; // Android emulator
        }
        else
        {
            serverUrl = "https://localhost:7178"; // PC
        }

        // Initialize JS Bomberman
        await JS.InvokeVoidAsync("bomberman.init", serverUrl);

        // Connect SignalR
        await HubClient.StartAsync(serverUrl);
    }

    private async Task Move(string direction)
    {
        await JS.InvokeVoidAsync("bomberman.move", direction);
        await HubClient.SendMove(direction);
    }

    private async Task PlaceBomb()
    {
        await JS.InvokeVoidAsync("bomberman.placeBomb");
        await HubClient.SendBomb();
    }

    private async Task ResetGame()
    {
        await JS.InvokeVoidAsync("bomberman.reset");
        await HubClient.SendReset();
    }
}